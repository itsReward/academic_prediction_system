{% extends "base.html" %}

{% block title %}Admin Dashboard - Academic Prediction System{% endblock %}

{% block head_extras %}
<!-- Additional CSS for this template -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<!-- DataTables CSS -->
<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<!-- Date Range Picker -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Admin Dashboard</h1>
        <div>
            <div class="input-group date-filter-group">
                <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                <input type="text" class="form-control" id="dateRangePicker" placeholder="Filter by date range">
                <button class="btn btn-outline-primary" id="refreshDataBtn">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- System Status Overview Cards -->
    <div class="row mb-4">
        <!-- Active Users Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Active Users</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ system_stats.active_users }}</div>
                            <div class="text-xs text-muted mt-1">{{ system_stats.user_change }}% change since last month</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Health Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                System Health</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">Excellent</div>
                            <div class="text-xs text-muted mt-1">Last checked: {{ system_stats.health_check_time }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-server fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Accuracy Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Prediction Accuracy</div>
                            <div class="row no-gutters align-items-center">
                                <div class="col-auto">
                                    <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800">{{ system_stats.model_accuracy }}%</div>
                                </div>
                                <div class="col">
                                    <div class="progress progress-sm mr-2">
                                        <div class="progress-bar bg-info" role="progressbar"
                                            style="width: {{ system_stats.model_accuracy }}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs text-muted mt-1">{{ system_stats.accuracy_change }}% change since last update</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-brain fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Students Card -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Total Students Monitored</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ system_stats.total_students }}</div>
                            <div class="text-xs text-muted mt-1">Across {{ system_stats.total_courses }} courses</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-graduate fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Institution-wide Analytics -->
    <div class="row mb-4">
        <!-- Chart Card -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Institution-wide Performance Metrics</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                            aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">View Options:</div>
                            <a class="dropdown-item" href="#" onclick="updatePerformanceChart('grades')">Average Grades</a>
                            <a class="dropdown-item" href="#" onclick="updatePerformanceChart('completion')">Completion Rates</a>
                            <a class="dropdown-item" href="#" onclick="updatePerformanceChart('risk')">At-Risk Percentages</a>
                            <a class="dropdown-item" href="#" onclick="updatePerformanceChart('retention')">Retention Rates</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" onclick="downloadChartAsImage('performanceChart')">Export Chart</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Distribution and Model Performance Card -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Risk Distribution</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie mb-4">
                        <canvas id="riskDistributionChart"></canvas>
                    </div>
                    <div class="text-center small">
                        <span class="me-2"><i class="fas fa-circle text-success"></i> Low Risk</span>
                        <span class="me-2"><i class="fas fa-circle text-warning"></i> Medium Risk</span>
                        <span><i class="fas fa-circle text-danger"></i> High Risk</span>
                    </div>
                    
                    <hr>
                    
                    <h6 class="font-weight-bold">Model Performance</h6>
                    <div class="text-center my-3">
                        <span class="d-block mb-1">Precision: {{ model_metrics.precision }}%</span>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: {{ model_metrics.precision }}%"></div>
                        </div>
                        
                        <span class="d-block mb-1">Recall: {{ model_metrics.recall }}%</span>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ model_metrics.recall }}%"></div>
                        </div>
                        
                        <span class="d-block mb-1">F1 Score: {{ model_metrics.f1_score }}%</span>
                        <div class="progress mb-3">
                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ model_metrics.f1_score }}%"></div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modelDetailsModal">
                            View Detailed Metrics
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Departments Performance and User Activity -->
    <div class="row mb-4">
        <!-- Departments Performance Card -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Departmental Performance</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="departmentsTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Department</th>
                                    <th>Students</th>
                                    <th>Avg. Grade</th>
                                    <th>At-Risk %</th>
                                    <th>Retention</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dept in departments %}
                                <tr>
                                    <td><a href="{{ url_for('web.department_detail', id=dept.id) }}">{{ dept.name }}</a></td>
                                    <td>{{ dept.students_count }}</td>
                                    <td>{{ dept.avg_grade }}</td>
                                    <td>
                                        <span class="badge bg-{{ dept.risk_color }}">{{ dept.at_risk_percentage }}%</span>
                                    </td>
                                    <td>{{ dept.retention_rate }}%</td>
                                    <td>
                                        {% if dept.trend > 0 %}
                                        <span class="text-success"><i class="fas fa-arrow-up"></i> {{ dept.trend }}%</span>
                                        {% elif dept.trend < 0 %}
                                        <span class="text-danger"><i class="fas fa-arrow-down"></i> {{ dept.trend }}%</span>
                                        {% else %}
                                        <span class="text-warning"><i class="fas fa-equals"></i> {{ dept.trend }}%</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Activity Card -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">User Activity</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                            aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">Filter By:</div>
                            <a class="dropdown-item" href="#" onclick="filterUserActivity('all')">All Users</a>
                            <a class="dropdown-item" href="#" onclick="filterUserActivity('faculty')">Faculty Only</a>
                            <a class="dropdown-item" href="#" onclick="filterUserActivity('students')">Students Only</a>
                            <a class="dropdown-item" href="#" onclick="filterUserActivity('admins')">Admins Only</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-bar">
                        <canvas id="userActivityChart"></canvas>
                    </div>
                    <hr>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h6 class="font-weight-bold">Top User Actions</h6>
                            <ul class="list-group list-group-flush">
                                {% for action in top_user_actions %}
                                <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    {{ action.name }}
                                    <span class="badge bg-primary rounded-pill">{{ action.count }}</span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="font-weight-bold">Active Users by Role</h6>
                            <div class="chart-pie mb-4">
                                <canvas id="userRolesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Management Cards -->
    <div class="row mb-4">
        <!-- Recent System Logs -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Recent System Logs</h6>
                    <a href="{{ url_for('web.system_logs') }}" class="btn btn-sm btn-primary">View All Logs</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Level</th>
                                    <th>Message</th>
                                    <th>Source</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in system_logs %}
                                <tr>
                                    <td>{{ log.timestamp }}</td>
                                    <td><span class="badge bg-{{ log.level_color }}">{{ log.level }}</span></td>
                                    <td>{{ log.message }}</td>
                                    <td>{{ log.source }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Resource Usage Card -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">System Resource Usage</h6>
                </div>
                <div class="card-body">
                    <h6 class="font-weight-bold">CPU Usage</h6>
                    <div class="progress mb-4">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: {{ system_resources.cpu_usage }}%"
                            aria-valuenow="{{ system_resources.cpu_usage }}" aria-valuemin="0" aria-valuemax="100">{{ system_resources.cpu_usage }}%</div>
                    </div>
                    
                    <h6 class="font-weight-bold">Memory Usage</h6>
                    <div class="progress mb-4">
                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ system_resources.memory_usage }}%"
                            aria-valuenow="{{ system_resources.memory_usage }}" aria-valuemin="0" aria-valuemax="100">{{ system_resources.memory_usage }}%</div>
                    </div>
                    
                    <h6 class="font-weight-bold">Disk Usage</h6>
                    <div class="progress mb-4">
                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ system_resources.disk_usage }}%"
                            aria-valuenow="{{ system_resources.disk_usage }}" aria-valuemin="0" aria-valuemax="100">{{ system_resources.disk_usage }}%</div>
                    </div>
                    
                    <h6 class="font-weight-bold">Database Connections</h6>
                    <div class="progress mb-4">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ system_resources.db_connection_usage }}%"
                            aria-valuenow="{{ system_resources.db_connection_usage }}" aria-valuemin="0" aria-valuemax="100">{{ system_resources.db_connection_usage }}%</div>
                    </div>
                    
                    <div class="text-center">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="border rounded p-3 mb-3">
                                    <h6 class="font-weight-bold">API Requests (24h)</h6>
                                    <h3 class="m-0">{{ system_resources.api_requests_24h }}</h3>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="border rounded p-3 mb-3">
                                    <h6 class="font-weight-bold">Average Response Time</h6>
                                    <h3 class="m-0">{{ system_resources.avg_response_time }} ms</h3>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#resourceHistoryModal">
                            <i class="fas fa-chart-line me-1"></i> View Historical Usage
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management and Quick Actions -->
    <div class="row mb-4">
        <!-- User Management Card -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">User Management</h6>
                    <div>
                        <button class="btn btn-sm btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="fas fa-user-plus me-1"></i> Add User
                        </button>
                        <a href="{{ url_for('web.user_management') }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-cog me-1"></i> Advanced
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="usersTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>{{ user.name }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>{{ user.role }}</td>
                                    <td>
                                        <span class="badge bg-{{ user.status_color }}">{{ user.status }}</span>
                                    </td>
                                    <td>{{ user.last_login }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-primary editUserBtn" data-user-id="{{ user.id }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-warning resetPasswordBtn" data-user-id="{{ user.id }}" data-user-email="{{ user.email }}">
                                                <i class="fas fa-key"></i>
                                            </button>
                                            <button type="button" class="btn btn-danger deleteUserBtn" data-user-id="{{ user.id }}" data-user-name="{{ user.name }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Card -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Administrator Actions</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-lg-6 mb-3">
                            <a href="{{ url_for('web.system_settings') }}" class="card bg-light border h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-cogs fa-3x text-gray-500 mb-3"></i>
                                    <h6 class="font-weight-bold">System Settings</h6>
                                </div>
                            </a>
                        </div>
                        <div class="col-lg-6 mb-3">
                            <a href="#" class="card bg-light border h-100" data-bs-toggle="modal" data-bs-target="#retrainModelModal">
                                <div class="card-body text-center">
                                    <i class="fas fa-sync-alt fa-3x text-gray-500 mb-3"></i>
                                    <h6 class="font-weight-bold">Retrain Model</h6>
                                </div>
                            </a>
                        </div>
                        <div class="col-lg-6 mb-3">
                            <a href="{{ url_for('web.data_management') }}" class="card bg-light border h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-database fa-3x text-gray-500 mb-3"></i>
                                    <h6 class="font-weight-bold">Data Management</h6>
                                </div>
                            </a>
                        </div>
                        <div class="col-lg-6 mb-3">
                            <a href="{{ url_for('web.reports') }}" class="card bg-light border h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-alt fa-3x text-gray-500 mb-3"></i>
                                    <h6 class="font-weight-bold">Generate Reports</h6>
                                </div>
                            </a>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <h6 class="font-weight-bold"><i class="fas fa-info-circle me-2"></i>System Status</h6>
                        <p class="mb-0">Last backup: <strong>{{ system_stats.last_backup }}</strong></p>
                        <p class="mb-0">Model version: <strong>{{ system_stats.model_version }}</strong></p>
                        <p class="mb-0">System version: <strong>{{ system_stats.system_version }}</strong></p>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#backupSystemModal">
                            <i class="fas fa-download me-1"></i> Backup System
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Details Modal -->
<div class="modal fade" id="modelDetailsModal" tabindex="-1" aria-labelledby="modelDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modelDetailsModalLabel">Machine Learning Model Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">Model Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Model Type:</strong> {{ model_info.model_type }}</p>
                                <p><strong>Training Date:</strong> {{ model_info.training_date }}</p>
                                <p><strong>Training Data Size:</strong> {{ model_info.training_data_size }} records</p>
                                <p><strong>Parameters:</strong> {{ model_info.parameters }}</p>
                                <p><strong>Last Evaluation:</strong> {{ model_info.last_evaluation }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">Performance Metrics</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <h6>Accuracy</h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: {{ model_metrics.accuracy }}%" aria-valuenow="{{ model_metrics.accuracy }}" aria-valuemin="0" aria-valuemax="100">{{ model_metrics.accuracy }}%</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <h6>Precision</h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ model_metrics.precision }}%" aria-valuenow="{{ model_metrics.precision }}" aria-valuemin="0" aria-valuemax="100">{{ model_metrics.precision }}%</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <h6>Recall</h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ model_metrics.recall }}%" aria-valuenow="{{ model_metrics.recall }}" aria-valuemin="0" aria-valuemax="100">{{ model_metrics.recall }}%</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <h6>F1 Score</h6>
                                    <div class="progress">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: {{ model_metrics.f1_score }}%" aria-valuenow="{{ model_metrics.f1_score }}" aria-valuemin="0" aria-valuemax="100">{{ model_metrics.f1_score }}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">Confusion Matrix</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="confusionMatrixChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">Feature Importance</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="featureImportanceChart" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#retrainModelModal">Retrain Model</button>
            </div>
        </div>
    </div>
</div>

<!-- Resource History Modal -->
<div class="modal fade" id="resourceHistoryModal" tabindex="-1" aria-labelledby="resourceHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resourceHistoryModalLabel">System Resource History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="nav nav-tabs mb-3" id="resourceTabs" role="tablist">
                    <button class="nav-link active" id="cpu-tab" data-bs-toggle="tab" data-bs-target="#cpu" type="button" role="tab" aria-controls="cpu" aria-selected="true">CPU Usage</button>
                    <button class="nav-link" id="memory-tab" data-bs-toggle="tab" data-bs-target="#memory" type="button" role="tab" aria-controls="memory" aria-selected="false">Memory Usage</button>
                    <button class="nav-link" id="disk-tab" data-bs-toggle="tab" data-bs-target="#disk" type="button" role="tab" aria-controls="disk" aria-selected="false">Disk Usage</button>
                    <button class="nav-link" id="db-tab" data-bs-toggle="tab" data-bs-target="#db" type="button" role="tab" aria-controls="db" aria-selected="false">DB Connections</button>
                </div>
                <div class="tab-content" id="resourceTabContent">
                    <div class="tab-pane fade show active" id="cpu" role="tabpanel" aria-labelledby="cpu-tab">
                        <canvas id="cpuHistoryChart" height="250"></canvas>
                    </div>
                    <div class="tab-pane fade" id="memory" role="tabpanel" aria-labelledby="memory-tab">
                        <canvas id="memoryHistoryChart" height="250"></canvas>
                    </div>
                    <div class="tab-pane fade" id="disk" role="tabpanel" aria-labelledby="disk-tab">
                        <canvas id="diskHistoryChart" height="250"></canvas>
                    </div>
                    <div class="tab-pane fade" id="db" role="tabpanel" aria-labelledby="db-tab">
                        <canvas id="dbHistoryChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Export Data</button>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label for="userName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="userName" required>
                    </div>
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="userRole" class="form-label">Role</label>
                        <select class="form-select" id="userRole" required>
                            <option value="">Select a role</option>
                            <option value="student">Student</option>
                            <option value="faculty">Faculty</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="userDepartment" class="form-label">Department</label>
                        <select class="form-select" id="userDepartment">
                            <option value="">Select a department</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="sendCredentials">
                        <label class="form-check-label" for="sendCredentials">Send login credentials via email</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn">Add User</button>
            </div>
        </div>
    </div>
</div>

<!-- Retrain Model Modal -->
<div class="modal fade" id="retrainModelModal" tabindex="-1" aria-labelledby="retrainModelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="retrainModelModalLabel">Retrain Prediction Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i> Retraining the model may take several minutes. The system will remain operational during this process.
                </div>
                <form id="retrainModelForm">
                    <div class="mb-3">
                        <label for="modelType" class="form-label">Model Type</label>
                        <select class="form-select" id="modelType" required>
                            <option value="random_forest">Random Forest</option>
                            <option value="gradient_boosting">Gradient Boosting</option>
                            <option value="xgboost">XGBoost</option>
                            <option value="neural_network">Neural Network</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="trainingDataset" class="form-label">Training Dataset</label>
                        <select class="form-select" id="trainingDataset" required>
                            <option value="current">Current Academic Year</option>
                            <option value="full">Full Historical Data</option>
                            <option value="custom">Custom Dataset</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="hyperparameterTuning" class="form-label">Hyperparameter Tuning</label>
                        <select class="form-select" id="hyperparameterTuning" required>
                            <option value="default">Use Default Parameters</option>
                            <option value="grid">Grid Search</option>
                            <option value="random">Random Search</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="featureSelection">
                        <label class="form-check-label" for="featureSelection">Perform automatic feature selection</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="crossValidation" checked>
                        <label class="form-check-label" for="crossValidation">Use cross-validation</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="startRetrainingBtn">Start Retraining</button>
            </div>
        </div>
    </div>
</div>

<!-- Backup System Modal -->
<div class="modal fade" id="backupSystemModal" tabindex="-1" aria-labelledby="backupSystemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backupSystemModalLabel">Backup System</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> Creating a backup will save all system settings, user data, and trained models.
                </div>
                <form id="backupForm">
                    <div class="mb-3">
                        <label for="backupType" class="form-label">Backup Type</label>
                        <select class="form-select" id="backupType" required>
                            <option value="full">Full System Backup</option>
                            <option value="data">Data Only</option>
                            <option value="config">Configuration Only</option>
                            <option value="models">ML Models Only</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="backupLocation" class="form-label">Backup Location</label>
                        <select class="form-select" id="backupLocation" required>
                            <option value="local">Local Server</option>
                            <option value="cloud">Cloud Storage</option>
                            <option value="download">Download to Computer</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="encryptBackup" checked>
                        <label class="form-check-label" for="encryptBackup">Encrypt backup</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="scheduleBackup">
                        <label class="form-check-label" for="scheduleBackup">Schedule regular backups</label>
                    </div>
                    <div class="mb-3" id="backupScheduleDiv" style="display: none;">
                        <label for="backupFrequency" class="form-label">Backup Frequency</label>
                        <select class="form-select" id="backupFrequency">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="startBackupBtn">Start Backup</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<!-- Date Range Picker -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

<script>
    // Initialize DataTables
    $(document).ready(function() {
        $('#departmentsTable').DataTable();
        $('#usersTable').DataTable();
        
        // Initialize Date Range Picker
        $('#dateRangePicker').daterangepicker({
            opens: 'left',
            ranges: {
               'Today': [moment(), moment()],
               'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
               'Last 7 Days': [moment().subtract(6, 'days'), moment()],
               'Last 30 Days': [moment().subtract(29, 'days'), moment()],
               'This Month': [moment().startOf('month'), moment().endOf('month')],
               'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
            },
            startDate: moment().subtract(29, 'days'),
            endDate: moment()
        }, function(start, end, label) {
            console.log("A date range was chosen: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
            // Here you would typically call a function to refresh data based on the selected date range
            refreshDashboardData(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'));
        });
        
        // Show/hide backup schedule options
        $('#scheduleBackup').change(function() {
            if ($(this).is(':checked')) {
                $('#backupScheduleDiv').show();
            } else {
                $('#backupScheduleDiv').hide();
            }
        });
        
        // Initialize all the charts
        initCharts();
        
        // Add event listener for refresh button
        $('#refreshDataBtn').click(function() {
            var dateRange = $('#dateRangePicker').val();
            var dates = dateRange.split(' - ');
            if (dates.length === 2) {
                refreshDashboardData(dates[0], dates[1]);
            } else {
                refreshDashboardData();
            }
        });
    });

    // Initialize charts
    function initCharts() {
        // Institution-wide Performance Metrics Chart
        var ctx1 = document.getElementById("performanceChart");
        window.performanceChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: {{ months|safe }},
                datasets: [{
                    label: "Average Grade",
                    lineTension: 0.3,
                    backgroundColor: "rgba(78, 115, 223, 0.05)",
                    borderColor: "rgba(78, 115, 223, 1)",
                    pointRadius: 3,
                    pointBackgroundColor: "rgba(78, 115, 223, 1)",
                    pointBorderColor: "rgba(78, 115, 223, 1)",
                    pointHoverRadius: 3,
                    pointHoverBackgroundColor: "rgba(78, 115, 223, 1)",
                    pointHoverBorderColor: "rgba(78, 115, 223, 1)",
                    pointHitRadius: 10,
                    pointBorderWidth: 2,
                    data: {{ performance_data.grades|safe }}
                }]
            },
            options: {
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 10,
                        right: 25,
                        top: 25,
                        bottom: 0
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            maxTicksLimit: 7
                        }
                    },
                    y: {
                        ticks: {
                            maxTicksLimit: 5,
                            padding: 10,
                            callback: function(value, index, values) {
                                return value.toFixed(1);
                            }
                        },
                        grid: {
                            color: "rgb(234, 236, 244)",
                            zeroLineColor: "rgb(234, 236, 244)",
                            drawBorder: false,
                            borderDash: [2],
                            zeroLineBorderDash: [2]
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: "rgb(255,255,255)",
                        bodyColor: "#858796",
                        titleMarginBottom: 10,
                        titleColor: '#6e707e',
                        titleFont: {
                            size: 14
                        },
                        borderColor: '#dddfeb',
                        borderWidth: 1,
                        xPadding: 15,
                        yPadding: 15,
                        displayColors: false,
                        intersect: false,
                        mode: 'index',
                        caretPadding: 10
                    }
                }
            }
        });

        // Risk Distribution Chart
        var ctx2 = document.getElementById("riskDistributionChart");
        window.riskDistributionChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ["Low Risk", "Medium Risk", "High Risk"],
                datasets: [{
                    data: [{{ system_stats.low_risk_count }}, {{ system_stats.medium_risk_count }}, {{ system_stats.high_risk_count }}],
                    backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'],
                    hoverBackgroundColor: ['#17a673', '#e3b12d', '#d32f2f'],
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                }],
            },
            options: {
                maintainAspectRatio: false,
                tooltips: {
                    backgroundColor: "rgb(255,255,255)",
                    bodyColor: "#858796",
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    caretPadding: 10,
                },
                legend: {
                    display: false
                },
                cutoutPercentage: 80,
            },
        });

        // User Activity Chart
        var ctx3 = document.getElementById("userActivityChart");
        window.userActivityChart = new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: {{ user_activity.dates|safe }},
                datasets: [{
                    label: "Active Users",
                    backgroundColor: "#4e73df",
                    hoverBackgroundColor: "#2e59d9",
                    borderColor: "#4e73df",
                    data: {{ user_activity.counts|safe }},
                }],
            },
            options: {
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 10,
                        right: 25,
                        top: 25,
                        bottom: 0
                    }
                },
                scales: {
                    xAxes: [{
                        gridLines: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            maxTicksLimit: 7
                        },
                    }],
                    yAxes: [{
                        ticks: {
                            min: 0,
                            maxTicksLimit: 5,
                            padding: 10,
                        },
                        gridLines: {
                            color: "rgb(234, 236, 244)",
                            zeroLineColor: "rgb(234, 236, 244)",
                            drawBorder: false,
                            borderDash: [2],
                            zeroLineBorderDash: [2]
                        }
                    }],
                },
                legend: {
                    display: false
                },
                tooltips: {
                    backgroundColor: "rgb(255,255,255)",
                    bodyColor: "#858796",
                    titleMarginBottom: 10,
                    titleColor: '#6e707e',
                    titleFontSize: 14,
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    caretPadding: 10,
                },
            }
        });

        // User Roles Chart
        var ctx4 = document.getElementById("userRolesChart");
        window.userRolesChart = new Chart(ctx4, {
            type: 'pie',
            data: {
                labels: ["Faculty", "Students", "Admins"],
                datasets: [{
                    data: [{{ user_roles.faculty }}, {{ user_roles.students }}, {{ user_roles.admins }}],
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc'],
                    hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf'],
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                }],
            },
            options: {
                maintainAspectRatio: false,
                tooltips: {
                    backgroundColor: "rgb(255,255,255)",
                    bodyColor: "#858796",
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    caretPadding: 10,
                },
                legend: {
                    display: false
                },
            },
        });

        // Modal Charts - Confusion Matrix
        var ctx5 = document.getElementById("confusionMatrixChart");
        window.confusionMatrixChart = new Chart(ctx5, {
            type: 'matrix',
            data: {
                datasets: [{
                    label: 'Confusion Matrix',
                    data: {{ confusion_matrix|safe }},
                    backgroundColor: function(context) {
                        var value = context.dataset.data[context.dataIndex].v;
                        var alpha = value / 10;
                        return 'rgba(78, 115, 223, ' + alpha + ')';
                    },
                    borderColor: 'white',
                    borderWidth: 1,
                    width: 20,
                    height: 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function() {
                                return '';
                            },
                            label: function(context) {
                                var v = context.dataset.data[context.dataIndex].v;
                                return ['Predicted: ' + context.dataset.data[context.dataIndex].y,
                                        'Actual: ' + context.dataset.data[context.dataIndex].x,
                                        'Value: ' + v
                                       ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Predicted Class'
                        },
                        ticks: {
                            stepSize: 1
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Actual Class'
                        },
                        ticks: {
                            stepSize: 1
                        },
                        offset: true
                    }
                }
            }
        });

        // Modal Charts - Feature Importance
        var ctx6 = document.getElementById("featureImportanceChart");
        window.featureImportanceChart = new Chart(ctx6, {
            type: 'bar',
            data: {
                labels: {{ feature_importance.features|safe }},
                datasets: [{
                    label: 'Importance',
                    data: {{ feature_importance.importance|safe }},
                    backgroundColor: 'rgba(78, 115, 223, 0.7)',
                    borderColor: 'rgba(78, 115, 223, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Resource History Charts
        initResourceCharts();
    }

    // Initialize resource history charts
    function initResourceCharts() {
        var timeLabels = {{ resource_history.timestamps|safe }};
        
        // CPU History Chart
        var ctx7 = document.getElementById("cpuHistoryChart");
        window.cpuHistoryChart = new Chart(ctx7, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'CPU Usage (%)',
                    data: {{ resource_history.cpu|safe }},
                    backgroundColor: 'rgba(231, 74, 59, 0.1)',
                    borderColor: 'rgba(231, 74, 59, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Usage (%)'
                        }
                    }
                }
            }
        });
        
        // Memory History Chart
        var ctx8 = document.getElementById("memoryHistoryChart");
        window.memoryHistoryChart = new Chart(ctx8, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Memory Usage (%)',
                    data: {{ resource_history.memory|safe }},
                    backgroundColor: 'rgba(246, 194, 62, 0.1)',
                    borderColor: 'rgba(246, 194, 62, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Usage (%)'
                        }
                    }
                }
            }
        });
        
        // Disk History Chart
        var ctx9 = document.getElementById("diskHistoryChart");
        window.diskHistoryChart = new Chart(ctx9, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Disk Usage (%)',
                    data: {{ resource_history.disk|safe }},
                    backgroundColor: 'rgba(54, 185, 204, 0.1)',
                    borderColor: 'rgba(54, 185, 204, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Usage (%)'
                        }
                    }
                }
            }
        });
        
        // DB Connections History Chart
        var ctx10 = document.getElementById("dbHistoryChart");
        window.dbHistoryChart = new Chart(ctx10, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'DB Connections (%)',
                    data: {{ resource_history.db|safe }},
                    backgroundColor: 'rgba(28, 200, 138, 0.1)',
                    borderColor: 'rgba(28, 200, 138, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Usage (%)'
                        }
                    }
                }
            }
        });
    }

    // Function to update performance chart based on selected metric
    function updatePerformanceChart(metric) {
        let chart = window.performanceChart;
        let dataset = chart.data.datasets[0];
        
        switch(metric) {
            case 'grades':
                dataset.label = "Average Grades";
                dataset.data = {{ performance_data.grades|safe }};
                dataset.borderColor = "rgba(78, 115, 223, 1)";
                dataset.backgroundColor = "rgba(78, 115, 223, 0.05)";
                dataset.pointBackgroundColor = "rgba(78, 115, 223, 1)";
                dataset.pointBorderColor = "rgba(78, 115, 223, 1)";
                break;
            case 'completion':
                dataset.label = "Completion Rates (%)";
                dataset.data = {{ performance_data.completion|safe }};
                dataset.borderColor = "rgba(28, 200, 138, 1)";
                dataset.backgroundColor = "rgba(28, 200, 138, 0.05)";
                dataset.pointBackgroundColor = "rgba(28, 200, 138, 1)";
                dataset.pointBorderColor = "rgba(28, 200, 138, 1)";
                break;
            case 'risk':
                dataset.label = "At-Risk Percentages (%)";
                dataset.data = {{ performance_data.risk|safe }};
                dataset.borderColor = "rgba(231, 74, 59, 1)";
                dataset.backgroundColor = "rgba(231, 74, 59, 0.05)";
                dataset.pointBackgroundColor = "rgba(231, 74, 59, 1)";
                dataset.pointBorderColor = "rgba(231, 74, 59, 1)";
                break;
            case 'retention':
                dataset.label = "Retention Rates (%)";
                dataset.data = {{ performance_data.retention|safe }};
                dataset.borderColor = "rgba(54, 185, 204, 1)";
                dataset.backgroundColor = "rgba(54, 185, 204, 0.05)";
                dataset.pointBackgroundColor = "rgba(54, 185, 204, 1)";
                dataset.pointBorderColor = "rgba(54, 185, 204, 1)";
                break;
        }
        
        chart.update();
    }

    // Function to filter user activity chart
    function filterUserActivity(role) {
        let chart = window.userActivityChart;
        
        // Simulate different data based on role filter
        switch(role) {
            case 'all':
                chart.data.datasets[0].data = {{ user_activity.counts|safe }};
                break;
            case 'faculty':
                chart.data.datasets[0].data = {{ user_activity.faculty_counts|safe }};
                break;
            case 'students':
                chart.data.datasets[0].data = {{ user_activity.student_counts|safe }};
                break;
            case 'admins':
                chart.data.datasets[0].data = {{ user_activity.admin_counts|safe }};
                break;
        }
        
        chart.update();
    }

    // Function to download chart as image
    function downloadChartAsImage(chartId) {
        const canvas = document.getElementById(chartId);
        const image = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = chartId + '.png';
        link.href = image;
        link.click();
    }

    // Function to refresh dashboard data based on date range
    function refreshDashboardData(startDate, endDate) {
        // Show loading indicator
        $('#refreshDataBtn').html('<span class="spinner-border spinner-border-sm"></span>');
        
        // This would be an AJAX call to fetch updated data
        // For now, simulate a refresh with a timeout
        setTimeout(function() {
            // Reset button
            $('#refreshDataBtn').html('<i class="fas fa-sync-alt"></i>');
            
            // Show success toast
            const toast = new bootstrap.Toast(document.getElementById('liveToast'));
            document.getElementById('toastTitle').innerHTML = 'Data Refreshed';
            document.getElementById('toastMessage').innerHTML = 'Dashboard data has been updated successfully.';
            document.getElementById('toastTime').innerHTML = 'Just now';
            toast.show();
        }, 1500);
    }

    // User Management Button Event Handlers
    $('.editUserBtn').on('click', function() {
        // Get user ID
        const userId = $(this).data('user-id');
        
        // In a real app, you'd fetch user details via AJAX
        // For now, just show a message
        alert('Edit user ID: ' + userId);
    });

    $('.resetPasswordBtn').on('click', function() {
        // Get user details
        const userId = $(this).data('user-id');
        const userEmail = $(this).data('user-email');
        
        if (confirm('Are you sure you want to reset the password for ' + userEmail + '?')) {
            // Show a loading spinner on the button
            $(this).html('<span class="spinner-border spinner-border-sm"></span>');
            
            // Simulate password reset
            setTimeout(() => {
                // Reset button
                $(this).html('<i class="fas fa-key"></i>');
                
                // Show success toast
                const toast = new bootstrap.Toast(document.getElementById('liveToast'));
                document.getElementById('toastTitle').innerHTML = 'Password Reset';
                document.getElementById('toastMessage').innerHTML = 'Password reset link has been sent to ' + userEmail;
                document.getElementById('toastTime').innerHTML = 'Just now';
                toast.show();
            }, 1500);
        }
    });

    $('.deleteUserBtn').on('click', function() {
        // Get user details
        const userId = $(this).data('user-id');
        const userName = $(this).data('user-name');
        
        if (confirm('Are you sure you want to delete the user ' + userName + '? This action cannot be undone.')) {
            // Show a loading spinner on the button
            $(this).html('<span class="spinner-border spinner-border-sm"></span>');
            
            // Simulate user deletion
            setTimeout(() => {
                // Remove the table row
                $(this).closest('tr').fadeOut(400, function() {
                    $(this).remove();
                });
                
                // Show success toast
                const toast = new bootstrap.Toast(document.getElementById('liveToast'));
                document.getElementById('toastTitle').innerHTML = 'User Deleted';
                document.getElementById('toastMessage').innerHTML = 'The user ' + userName + ' has been deleted successfully.';
                document.getElementById('toastTime').innerHTML = 'Just now';
                toast.show();
            }, 1500);
        }
    });

    // Add User Button Event Handler
    $('#saveUserBtn').on('click', function() {
        // Validate form
        const form = document.getElementById('addUserForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Show loading spinner
        $(this).html('<span class="spinner-border spinner-border-sm"></span> Adding...');
        
        // Simulate user creation
        setTimeout(() => {
            // Close modal
            $('#addUserModal').modal('hide');
            
            // Reset form
            form.reset();
            
            // Reset button
            $(this).html('Add User');
            
            // Show success toast
            const toast = new bootstrap.Toast(document.getElementById('liveToast'));
            document.getElementById('toastTitle').innerHTML = 'User Added';
            document.getElementById('toastMessage').innerHTML = 'The new user has been added successfully.';
            document.getElementById('toastTime').innerHTML = 'Just now';
            toast.show();
            
            // In a real app, you would refresh the users table
        }, 1500);
    });

    // Retrain Model Button Event Handler
    $('#startRetrainingBtn').on('click', function() {
        // Validate form
        const form = document.getElementById('retrainModelForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Show loading spinner
        $(this).html('<span class="spinner-border spinner-border-sm"></span> Retraining...');
        
        // Close the modal
        $('#retrainModelModal').modal('hide');
        
        // Show a progress modal or notification
        const toast = new bootstrap.Toast(document.getElementById('liveToast'));
        document.getElementById('toastTitle').innerHTML = 'Model Retraining';
        document.getElementById('toastMessage').innerHTML = 'Model retraining has been initiated. You will be notified when complete.';
        document.getElementById('toastTime').innerHTML = 'Just now';
        toast.show();
        
        // Simulate retraining process (would be a background task in real app)
        setTimeout(() => {
            // Reset button
            $(this).html('Start Retraining');
            
            // Show completion toast
            document.getElementById('toastTitle').innerHTML = 'Retraining Complete';
            document.getElementById('toastMessage').innerHTML = 'The prediction model has been retrained successfully with improved accuracy.';
            document.getElementById('toastTime').innerHTML = 'Just now';
            toast.show();
            
            // Reset form
            form.reset();
        }, 5000);
    });

    // Backup System Button Event Handler
    $('#startBackupBtn').on('click', function() {
        // Validate form
        const form = document.getElementById('backupForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Show loading spinner
        $(this).html('<span class="spinner-border spinner-border-sm"></span> Backing up...');
        
        // Simulate backup process
        setTimeout(() => {
            // Close modal
            $('#backupSystemModal').modal('hide');
            
            // Reset button
            $(this).html('Start Backup');
            
            // Show success toast
            const toast = new bootstrap.Toast(document.getElementById('liveToast'));
            document.getElementById('toastTitle').innerHTML = 'Backup Complete';
            document.getElementById('toastMessage').innerHTML = 'System backup has been completed successfully.';
            document.getElementById('toastTime').innerHTML = 'Just now';
            toast.show();
            
            // Reset form
            form.reset();
            $('#backupScheduleDiv').hide();
        }, 2000);
    });
</script>
{% endblock %}